<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Lesson</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap');

body {
  padding: 30px 20px;
  background: linear-gradient(135deg, #f0f4ff, #d9e8ff);
  font-family: 'Inter', sans-serif;
  color: #222;
  min-height: 100vh;
  display: flex;
  justify-content: center;
}

.container {
  max-width: 900px;
  background: #fff;
  border-radius: 15px;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  padding: 30px 40px;
}

a.btn-link {
  color: #5a7fff;
  font-weight: 600;
  text-decoration: none;
  transition: color 0.3s ease;
}
a.btn-link:hover {
  color: #2e4fff;
  text-decoration: underline;
}

h2#lessonTitle {
  font-weight: 700;
  margin-bottom: 25px;
  font-size: 2.4rem;
  color: #2e3a8c;
  letter-spacing: 0.02em;
  text-align: center;
}

/* Tabs */
.nav-tabs {
  border-bottom: none;
  justify-content: center;
  margin-bottom: 25px;
}
.nav-tabs .nav-link {
  font-weight: 600;
  font-size: 1.1rem;
  border: none;
  border-radius: 50px;
  padding: 10px 30px;
  color: #5a7fff;
  background: #e6ecff;
  margin: 0 8px;
  transition: all 0.3s ease;
  box-shadow: inset 0 0 0 0 transparent;
}
.nav-tabs .nav-link.active {
  background: linear-gradient(90deg, #5a7fff, #2e4fff);
  color: white;
  box-shadow: 0 6px 16px rgba(46, 79, 255, 0.4);
}
.nav-tabs .nav-link:hover:not(.active) {
  background: #c0d0ff;
  color: #2e4fff;
}

/* Tab content */
.tab-content {
  background: #f9fbff;
  border-radius: 12px;
  box-shadow: inset 0 0 10px rgba(46, 79, 255, 0.05);
  min-height: 250px;
}

/* Questions */
.question {
  background: #fff;
  border-radius: 12px;
  padding: 18px 22px;
  box-shadow: 0 3px 10px rgba(46, 79, 255, 0.07);
  transition: transform 0.2s ease;
}
.question:hover {
  transform: translateY(-4px);
}

.question p {
  font-size: 1.1rem;
  font-weight: 600;
  color: #3b4176;
}

.question div {
  margin-top: 10px;
}

.question input[type="radio"] {
  accent-color: #5a7fff;
  cursor: pointer;
  width: 18px;
  height: 18px;
}

.question label {
  margin-left: 12px;
  cursor: pointer;
  font-weight: 500;
  color: #444;
  user-select: none;
  transition: color 0.3s ease;
}

.question label:hover {
  color: #5a7fff;
}

.correct {
  color: #198754 !important; /* Bootstrap green */
  font-weight: 700 !important;
}

.incorrect {
  color: #dc3545 !important; /* Bootstrap red */
  font-weight: 700 !important;
}

/* Buttons */
.d-flex.gap-2 button {
  flex: 1;
  font-weight: 600;
  border-radius: 50px;
  padding: 10px 0;
  transition: background 0.3s ease, box-shadow 0.3s ease;
}
#checkBtn {
  background: #5a7fff;
  border: none;
  color: #fff;
  box-shadow: 0 6px 12px rgba(90, 127, 255, 0.5);
}
#checkBtn:hover {
  background: #2e4fff;
  box-shadow: 0 8px 20px rgba(46, 79, 255, 0.7);
}
#resetBtn {
  border: 2px solid #5a7fff;
  color: #5a7fff;
  background: transparent;
}
#resetBtn:hover {
  background: #5a7fff;
  color: white;
  box-shadow: 0 6px 12px rgba(90, 127, 255, 0.5);
}

/* Score box */
.score-box {
  font-weight: 700;
  font-size: 1.25rem;
  color: #2e3a8c;
  user-select: none;
  align-self: center;
  min-width: 140px;
  text-align: center;
}

/* Responsive */
@media (max-width: 600px) {
  .container {
    padding: 20px 15px;
  }
  h2#lessonTitle {
    font-size: 1.8rem;
  }
  .nav-tabs .nav-link {
    padding: 8px 16px;
    font-size: 1rem;
    margin: 0 5px;
  }
}

  </style>
</head>
<body>

  <div class="container">
    <a href="pages/Grammer.html" class="btn btn-link mb-3">&larr; Back to Grammar</a>
    <h2 id="lessonTitle">Lesson</h2>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="lessonTabs" role="tablist">
      <li class="nav-item" role="presentation">
        <button class="nav-link active" id="explanation-tab" data-bs-toggle="tab" data-bs-target="#explanation" type="button">Explanation</button>
      </li>
      <li class="nav-item" role="presentation">
        <button class="nav-link" id="exercises-tab" data-bs-toggle="tab" data-bs-target="#exercises" type="button">Exercises</button>
      </li>
    </ul>

    <div class="tab-content p-3 border border-top-0">
      <div id="explanation" class="tab-pane fade show active"></div>
      <div id="exercises" class="tab-pane fade">
        <div id="exercisesContent"></div>

        <div class="d-flex gap-2 mt-3">
          <button id="checkBtn" class="btn btn-primary">Check Answers</button>
          <button id="resetBtn" class="btn btn-outline-secondary">Reset</button>
          <div class="ms-auto score-box" id="scoreBox"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- data.js must be available (مسار مثل اللي تستخدمه في Grammer.html) -->
  <script src="js/data.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>


  
  <script>
    // Helper to get URL params
    const params = new URLSearchParams(window.location.search);
    const level = params.get('level') || '';
    const slug = params.get('slug') || null;
    const titleParam = params.get('title') || null;

    function toSlug(text=''){ return text.toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,''); }

    // findLesson: by slug OR by title in grammarData[level]
    function findLesson() {
  if (!grammarData) return null;

  // البحث في جميع المستويات
  for (const level of Object.keys(grammarData)) {
    const lesson = grammarData[level].find(item => item.slug === slug);
    if (lesson) {
      // إذا لم يكن هناك تمارين، ننشئها تلقائياً
      if (!lesson.exercises || lesson.exercises.length === 0) {
      lesson.exercises = generateDefaultMCQs(lesson.slug || toSlug(lesson.title), 30);
      }
      return lesson;
    }
  }

  return null;
}


    // default generator example (Present Simple). Can extend for other topics.
    function generateDefaultMCQs(topicSlug, n=40){
      if(topicSlug && topicSlug.includes('present-simple')){
        const subjects = ["I","You","We","They","He","She","It"];
        const verbs = ["play","eat","go","study","watch","drink","like","work","read","live"];
        const arr = [];
        for(let i=0;i<n;i++){
          const subj = subjects[i % subjects.length];
          const verb = verbs[i % verbs.length];
          const is3rd = ["He","She","It"].includes(subj);
          const correct = is3rd ? `${verb}s` : verb;
          const wrong = is3rd ? verb : `${verb}s`;
          // randomize option order half the time
          if(Math.random() < 0.5) arr.push({ q: `${subj} ____ football.`, opts: [wrong, correct], a: 1 });
          else arr.push({ q: `${subj} ____ football.`, opts: [correct, wrong], a: 0 });
        }
        return arr;
      }

      // Generic fallback: simple true/false style
      const arr = [];
      for(let i=0;i<n;i++){
        arr.push({ q: `Question ${i+1} (no specific generator for this topic).`, opts: ["True","False"], a: 0 });
      }
      return arr;
    }

    // Render lesson
    const lesson = findLesson();
    if(!lesson){
      document.getElementById('lessonTitle').textContent = 'Lesson not found';
      document.getElementById('explanation').innerHTML = '<p>No lesson data was found for this topic.</p>';
    } else {
      document.getElementById('lessonTitle').textContent = lesson.title || titleParam || 'Lesson';
      document.getElementById('explanation').innerHTML = lesson.explanation || '<p>No explanation yet.</p>';

      // exercises
      let exercises = lesson.exercises || null;
      if(!exercises || !Array.isArray(exercises) || exercises.length === 0){
        // generate default if possible
        exercises = generateDefaultMCQs(slug || toSlug(lesson.title), 30);
      } else {
        // limit to 30
        exercises = exercises.slice(0,40);
      }

      // render exercises UI
      const exWrap = document.getElementById('exercisesContent');
      function renderExercises(){
        exWrap.innerHTML = '';
        exercises.forEach((ex, i) => {
          const div = document.createElement('div');
          div.className = 'question mb-3 p-2 border rounded';
          const p = document.createElement('p');
          p.innerHTML = `<strong>${i+1}.</strong> ${ex.q}`;
          div.appendChild(p);

          ex.opts.forEach((opt, j) => {
            const id = `q${i}_opt${j}`;
            const radio = document.createElement('input');
            radio.type = 'radio';
            radio.name = `q${i}`;
            radio.value = j;
            radio.id = id;

            const label = document.createElement('label');
            label.htmlFor = id;
            label.id = `${id}_label`;
            label.innerText = opt;

            const wrapper = document.createElement('div');
            wrapper.appendChild(radio);
            wrapper.appendChild(label);
            div.appendChild(wrapper);
          });

          exWrap.appendChild(div);
        });
      }

      renderExercises();

      // Check answers
      document.getElementById('checkBtn').addEventListener('click', () => {
        let score = 0;
        exercises.forEach((ex, i) => {
          const selected = document.querySelector(`input[name="q${i}"]:checked`);
          const user = selected ? parseInt(selected.value,10) : null;
          const correct = ex.a === undefined ? 0 : ex.a;
          // color labels
          ex.opts.forEach((_, j) => {
            const lab = document.getElementById(`q${i}_opt${j}_label`);
            // lab may be null because id used is label id earlier formatting
            const labelId = `q${i}_opt${j}_label`;
            const labelElem = document.getElementById(labelId);
            if(labelElem){
              labelElem.classList.remove('correct','incorrect');
              if(j === correct) labelElem.classList.add('correct');
              else if(user === j && user !== correct) labelElem.classList.add('incorrect');
            }
          });
          if(user === correct) score++;
        });
        document.getElementById('scoreBox').textContent = `Score: ${score} / ${exercises.length}`;
      });

      // Reset
      document.getElementById('resetBtn').addEventListener('click', () => {
        document.querySelectorAll('#exercisesContent input[type=radio]').forEach(r => r.checked = false);
        document.getElementById('scoreBox').textContent = '';
        // remove highlight classes
        document.querySelectorAll('#exercisesContent label').forEach(l => { l.classList.remove('correct','incorrect'); });
      });
    }

    
  </script>
</body>
</html>
