<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>EnglishWithNour - Grammar</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container-fluid px-0">
        <header class="navbar">
            <div class="container">
                <a href="../index.html" class="logo-bg" aria-label="EnglishWithNour logo"></a>
                <!-- Hamburger Menu Button -->
                <button class="hamburger" id="hamburger" aria-label="Toggle menu" aria-expanded="false">
                    <span aria-hidden="true">‚ò∞</span>
                </button>
                <!-- Navigation links -->
                <nav id="nav-links" aria-label="Main navigation">
                    <a href="../index.html">Home</a>
                    <a href="Grammer.html" class="active" aria-current="page">Grammer</a>
                    <a href="Vocabulary.html">Vocabulary</a>
                    <a href="../ComingSoon.html">Listening</a>
                    <a href="../ComingSoon.html">Writing</a>
                    <a href="../ComingSoon.html">Reading</a>
                    <a href="../ComingSoon.html">Exams</a>
                </nav>
                <div class="account-btn" role="button" tabindex="0">Sign in</div>
            </div>
        </header>

        <div class="grammar-container">
            <header class="grammar-header">
                <div class="grammar-tabs" id="levelTabs" role="tablist" aria-label="Grammar Levels">
                    <button class="grammar-tab active" data-level="A1" role="tab" aria-selected="true" aria-controls="cardsArea" id="tab-A1">
                         A1 Elementary
                    </button>
                    <button class="grammar-tab" data-level="A2" role="tab" aria-selected="false" aria-controls="cardsArea" id="tab-A2">
                         A2 Pre-intermediate
                    </button>
                    <button class="grammar-tab" data-level="B1" role="tab" aria-selected="false" aria-controls="cardsArea" id="tab-B1">
                         B1 Intermediate
                    </button>
                    <button class="grammar-tab" data-level="B2" role="tab" aria-selected="false" aria-controls="cardsArea" id="tab-B2">
                         B2 Upper-intermediate
                    </button>
                    <button class="grammar-tab" data-level="C1" role="tab" aria-selected="false" aria-controls="cardsArea" id="tab-C1">
                        C1 Advanced
                    </button>
                </div>
                <div class="grammar-search-box">
                    <input 
                        id="searchInput" 
                        type="text"
                        placeholder="Search for grammar topics..." 
                        aria-label="Search grammar topics"
                    />
                </div>
            </header>

            <main>
                <div class="grammar-level-header">
                    <h2 id="levelTitle">A1 ‚Äî Elementary</h2>
                    <div class="grammar-progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-labelledby="levelTitle">
                        <i id="progressBar"></i>
                    </div>
                    <div id="progressPct" aria-label="Progress percentage">0%</div>
                </div>

                <div id="cardsArea" class="grammar-cards" role="region" aria-labelledby="levelTitle">
                    <div class="grammar-empty-spot">
                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #3498db; margin-bottom: 15px;"></i>
                        <p>Loading grammar content...</p>
                    </div>
                </div>

                <div id="detailArea" style="margin-top:18px"></div>
            </main>
        </div>

        <footer class="footer">
  <div class="footer-container">

    <!-- Brand -->
    <div class="footer-brand">
      <h2>EnglishWithNour</h2>
      <p>Learn English step-by-step with fun and interactive lessons designed for Arabic speakers of all ages.</p>
    </div>

    <!-- Skills -->
    <div class="footer-skills">
      <h3>Explore</h3>
      <div class="skills-columns">
        <ul>
          <li><a href="Grammer.html">Grammer</a></li>
          <li><a href="Vocabulary.html">Vocabulary</a></li>
        </ul>
        <ul>
          <li><a href="../ComingSoon.html">Reading</a></li>
          <li><a href="../ComingSoon.html">Writing</a></li>
        </ul>
        <ul>
          <li><a href="../ComingSoon.html">Listening</a></li>
          <li><a href="../ComingSoon.html">Exams</a></li>
        </ul>
      </div>
    </div>

    <!-- Social -->
    <div class="footer-social">
      <h3>Follow Us</h3>
      <div class="social-icons">
        <a href="#"><i class="fab fa-facebook-f"></i></a>
        <a href="#"><i class="fab fa-youtube"></i></a>
        <a href="#"><i class="fab fa-instagram"></i></a>
      </div>
    </div>

  </div>

  <div class="footer-bottom">
    <p>¬© 2025 English With Nour. All rights reserved.</p>
  </div>
</footer>
    </div>

   

    <!-- Load data.js which declares grammarData -->
    <script src="../js/data.js"></script>

    <script>
        // Global variables
        let currentLevel = 'A1';
        let isDataLoaded = false;
        let dataLoadAttempts = 0;
        const maxDataLoadAttempts = 3;

        // Hamburger Menu Toggle
        const hamburger = document.getElementById('hamburger');
        const navLinks = document.getElementById('nav-links');

        if (hamburger && navLinks) {
            hamburger.addEventListener('click', () => {
                const isExpanded = hamburger.getAttribute('aria-expanded') === 'true';
                hamburger.setAttribute('aria-expanded', !isExpanded);
                navLinks.classList.toggle('active');
            });
        }

        // Helper: toSlug (backup if data.js doesn't load)
        function toSlug(text) {
            return String(text || '').toLowerCase()
                .replace(/[^a-z0-9]+/g, '-')
                .replace(/(^-|-$)/g, '');
        }

        // Utility: safe key for localStorage
        const keyFor = (level, slug) => `completed::${level}::${slug}`;

        // Check if data is loaded with retry mechanism
        function waitForData(callback, maxTries = 50) {
            if (typeof grammarData !== 'undefined' && grammarData) {
                isDataLoaded = true;
                console.log('‚úÖ Grammar data loaded successfully');
                callback();
            } else if (dataLoadAttempts < maxDataLoadAttempts && maxTries > 0) {
                setTimeout(() => {
                    dataLoadAttempts++;
                    console.log(`üîÑ Attempting to load data (attempt ${dataLoadAttempts})...`);
                    waitForData(callback, maxTries - 1);
                }, 300);
            } else {
                console.warn('‚ö†Ô∏è Using fallback data - data.js not loaded');
                window.grammarData = fallbackData;
                isDataLoaded = true;
                callback();
            }
        }

        // Show error message
        function showError(message) {
            const area = document.getElementById('cardsArea');
            if (area) {
                area.innerHTML = `
                    <div class="grammar-empty-spot">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: #e74c3c; margin-bottom: 15px;"></i>
                        <p>${message}</p>
                        <button class="grammar-btn" onclick="location.reload()">
                            <i class="fas fa-refresh"></i> Reload Page
                        </button>
                    </div>
                `;
            }
        }

        // Render cards for currentLevel (filtered by searchTerm)
        function renderCards(filter = '') {
            if (!isDataLoaded) {
                console.warn('‚ö†Ô∏è Data not loaded yet, waiting...');
                waitForData(() => renderCards(filter));
                return;
            }

            const area = document.getElementById('cardsArea');
            if (!area) return;

            area.innerHTML = '';

            const levelData = grammarData[currentLevel];
            if (!levelData || levelData.length === 0) {
                area.innerHTML = `
                    <div class="grammar-empty-spot">
                        <i class="fas fa-construction" style="font-size: 2rem; color: #f39c12; margin-bottom: 15px;"></i>
                        <p>This level is under development.</p>
                        <p>Please check other levels or come back later!</p>
                    </div>
                `;
                return;
            }

            const list = levelData.filter(item =>
                item.title.toLowerCase().includes(filter.toLowerCase())
            );

            if (!list.length) {
                area.innerHTML = `
                    <div class="grammar-empty-spot">
                        <i class="fas fa-search" style="font-size: 2rem; color: #3498db; margin-bottom: 15px;"></i>
                        <p>No grammar topics found matching "${filter}"</p>
                        <p>Try a different search term or browse all topics.</p>
                    </div>
                `;
                return;
            }

            list.forEach((item, index) => {
                // Ensure slug exists
                if (!item.slug) {
                    item.slug = toSlug(item.title);
                }

                const card = document.createElement('div');
                card.className = 'grammar-card';
                card.style.animationDelay = `${index * 0.1}s`;
                card.setAttribute('aria-label', `Grammar topic: ${item.title}`);

                const title = document.createElement('div');
                title.className = 'title';
                title.textContent = item.title;

                const actions = document.createElement('div');
                actions.className = 'actions';

                // Checkbox for completion tracking
                const chk = document.createElement('input');
                chk.type = 'checkbox';
                chk.id = `chk-${currentLevel}-${item.slug}`;
                chk.title = 'Mark as completed';
                chk.setAttribute('aria-label', `Mark ${item.title} as completed`);
                chk.checked = !!localStorage.getItem(keyFor(currentLevel, item.slug));
                chk.addEventListener('change', () => {
                    if (chk.checked) {
                        localStorage.setItem(keyFor(currentLevel, item.slug), '1');
                    } else {
                        localStorage.removeItem(keyFor(currentLevel, item.slug));
                    }
                    updateProgress();
                });

                // Label for checkbox
                const label = document.createElement('label');
                label.setAttribute('for', `chk-${currentLevel}-${item.slug}`);
                label.style.marginRight = '10px';
                label.textContent = 'Completed';
                label.style.fontSize = '0.9rem';
                label.style.color = '#666';

                // Open button
                const openBtn = document.createElement('button');
                openBtn.className = 'grammar-btn';
                openBtn.innerHTML = ' Start Learning';
                openBtn.setAttribute('aria-label', `Start learning ${item.title}`);
                openBtn.addEventListener('click', () => {
                    // Save current state
                    localStorage.setItem('lastLevel', currentLevel);
                    
                    // Navigate to lesson page
                    const url = `../lesson.html?level=${encodeURIComponent(currentLevel)}&slug=${encodeURIComponent(item.slug)}`;
                    window.location.href = url;
                });

                actions.append(chk, label, openBtn);
                card.append(title, actions);
                area.appendChild(card);
            });

            updateProgress();
        }

        // Update progress bar and percentage
        function updateProgress() {
            if (!isDataLoaded) return;

            const levelData = grammarData[currentLevel];
            if (!levelData) return;

            const total = levelData.length;
            let completed = 0;

            levelData.forEach(item => {
                if (!item.slug) item.slug = toSlug(item.title);
                if (localStorage.getItem(keyFor(currentLevel, item.slug))) {
                    completed++;
                }
            });

            const percentage = total ? Math.round((completed / total) * 100) : 0;
            
            const progressBar = document.getElementById('progressBar');
            const progressPct = document.getElementById('progressPct');
            const progressContainer = document.querySelector('.grammar-progress');
            
            if (progressBar) {
                progressBar.style.width = percentage + '%';
            }
            
            if (progressContainer) {
                progressContainer.setAttribute('aria-valuenow', percentage);
            }
            
            if (progressPct) {
                progressPct.textContent = percentage + '%';
            }
        }

        // Tab switching functionality
        function initializeTabs() {
            document.querySelectorAll('.grammar-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    // Update ARIA attributes for all tabs
                    document.querySelectorAll('.grammar-tab').forEach(t => {
                        t.setAttribute('aria-selected', 'false');
                        t.classList.remove('active');
                    });
                    
                    // Add active class to clicked tab and update ARIA
                    tab.classList.add('active');
                    tab.setAttribute('aria-selected', 'true');
                    
                    // Update current level
                    currentLevel = tab.dataset.level || 'A1';
                    
                    // Save to localStorage
                    localStorage.setItem('selectedLevel', currentLevel);
                    
                    // Update level title
                    const levelTitle = document.getElementById('levelTitle');
                    if (levelTitle) {
                        levelTitle.textContent = `${currentLevel} ‚Äî ${tab.textContent.trim()}`;
                    }
                    
                    // Clear detail area
                    const detailArea = document.getElementById('detailArea');
                    if (detailArea) detailArea.innerHTML = '';
                    
                    // Re-render cards for new level
                    const searchInput = document.getElementById('searchInput');
                    renderCards(searchInput ? searchInput.value : '');
                });
                
                // Add keyboard support
                tab.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        tab.click();
                    }
                });
            });
        }

        // Search functionality
        function initializeSearch() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                let searchTimeout;
                
                searchInput.addEventListener('input', (e) => {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(() => {
                        renderCards(e.target.value);
                    }, 300);
                });
                
                // Clear search on Escape
                searchInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        searchInput.value = '';
                        renderCards('');
                    }
                });
            }
        }

        // Load saved level and initialize
        function initializePage() {
            // Load saved level
            const savedLevel = localStorage.getItem('selectedLevel') || 
                              localStorage.getItem('lastLevel') || 
                              'A1';
            
            // Find and activate the saved tab
            const savedTab = document.querySelector(`.grammar-tab[data-level="${savedLevel}"]`);
            if (savedTab) {
                currentLevel = savedLevel;
                
                // Update active tab
                document.querySelectorAll('.grammar-tab').forEach(t => {
                    t.classList.remove('active');
                    t.setAttribute('aria-selected', 'false');
                });
                savedTab.classList.add('active');
                savedTab.setAttribute('aria-selected', 'true');
                
                // Update title
                const levelTitle = document.getElementById('levelTitle');
                if (levelTitle) {
                    levelTitle.textContent = `${savedLevel} ‚Äî ${savedTab.textContent.trim()}`;
                }
            }
            
            // Initialize components
            initializeTabs();
            initializeSearch();
            
            // Wait for data and render cards
            waitForData(() => {
                console.log('üìö Available levels:', Object.keys(grammarData));
                renderCards();
            });
        }

        // Initialize when DOM is loaded
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializePage);
        } else {
            initializePage();
        }

        // Expose for debugging
        if (typeof window !== 'undefined') {
            window.grammarDebug = {
                currentLevel: () => currentLevel,
                renderCards,
                updateProgress,
                grammarData: () => window.grammarData || grammarData
            };
        }
    </script>
</body>
</html>
