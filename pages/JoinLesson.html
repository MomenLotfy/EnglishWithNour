<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>EnglishWithNour - احجز جلستك</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3a0ca3;
      --accent: #4cc9f0;
      --success: #4ade80;
      --warning: #f59e0b;
      --danger: #ef4444;
      --light: #f8fafc;
      --dark: #1e293b;
      --gray: #64748b;
      --gradient: linear-gradient(135deg, #4361ee, #3a0ca3);
      --shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
      --radius: 12px;
    }
    
    * {margin: 0; padding: 0; box-sizing: border-box; font-family: "Tajawal", Tahoma, Arial, sans-serif;}
    body {
      background: #f1f5f9;
      color: #333;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      direction: rtl;
    }

    header {
      background: var(--gradient);
      padding: 20px;
      text-align: center;
      box-shadow: var(--shadow);
      position: relative;
      color: white;
    }
    header h1 {
      margin: 0;
      font-size: 24px;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    header button {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      color: var(--primary);
      border: none;
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: var(--shadow);
    }

    .container {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 2fr;
      gap: 25px;
      padding: 30px;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
    }

    .booking-section {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .booking, .schedule {
      background: #fff;
      border-radius: var(--radius);
      padding: 25px;
      box-shadow: var(--shadow);
    }

    .booking h2, .schedule h2 {
      margin-bottom: 20px;
      font-size: 22px;
      color: var(--dark);
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }

    /* Weekly Schedule Styles */
    .schedule-grid {
      display: grid;
      grid-template-columns: 120px repeat(7, 1fr);
      gap: 2px;
      background: #e2e8f0;
      border-radius: 8px;
      padding: 2px;
      margin-bottom: 20px;
    }

    .day-header {
      background: var(--primary);
      color: white;
      padding: 10px 5px;
      text-align: center;
      font-weight: bold;
      font-size: 12px;
      border-radius: 6px;
    }

    .time-slot {
      background: white;
      padding: 8px 5px;
      text-align: center;
      font-size: 11px;
      font-weight: bold;
      color: var(--dark);
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slot {
      background: #f8fafc;
      padding: 8px 4px;
      text-align: center;
      font-size: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border-radius: 6px;
      position: relative;
      min-height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .slot.available {
      background: #dcfce7;
      color: #166534;
      border: 2px solid transparent;
    }

    .slot.available:hover {
      background: var(--success);
      color: white;
      transform: scale(1.05);
    }

    .slot.booked {
      background: #fecaca;
      color: #991b1b;
      cursor: not-allowed;
    }

    .slot.selected {
      background: var(--primary);
      color: white;
      border: 2px solid var(--secondary);
      transform: scale(1.05);
    }

    .slot.teacher-break {
      background: #fef3c7;
      color: #92400e;
    }

    /* Form Styles */
    .booking form {
      display: flex;
      flex-direction: column;
    }

    .booking label {
      margin: 15px 0 8px;
      font-weight: bold;
      font-size: 15px;
      color: var(--dark);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .booking input, .booking select {
      padding: 14px;
      border: 2px solid #e2e8f0;
      border-radius: 10px;
      outline: none;
      text-align: right;
      font-size: 15px;
      transition: 0.2s;
      background: #fff;
    }

    .booking input:focus, .booking select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.2);
    }

    .booking button {
      margin-top: 25px;
      padding: 14px;
      background: var(--primary);
      border: none;
      border-radius: 10px;
      font-size: 16px;
      font-weight: bold;
      color: #fff;
      cursor: pointer;
      transition: 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: var(--shadow);
    }

    .booking button:hover {
      background: var(--secondary);
      transform: translateY(-2px);
    }

    .booking button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .success-message, .error-message {
      display: none;
      padding: 12px;
      border-radius: 8px;
      font-weight: bold;
      text-align: center;
      margin-bottom: 20px;
    }

    .success-message {
      background: #e6ffed;
      color: #2e7d32;
      border: 1px solid #4ade80;
    }

    .error-message {
      background: #ffebee;
      color: #c62828;
      border: 1px solid #ef4444;
    }

    /* Meeting Section */
    .meeting {
      background: #fff;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .meeting h2 {
      background: var(--light);
      padding: 15px;
      text-align: center;
      font-size: 20px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      color: var(--dark);
    }

    #meet {
      flex: 1;
      min-height: 500px;
    }

    .meeting-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      background: #1e293b;
      color: white;
      padding: 20px;
      text-align: center;
    }

    .meeting-controls {
      display: flex;
      justify-content: center;
      gap: 10px;
      padding: 15px;
      background: var(--light);
      border-top: 1px solid #e2e8f0;
    }

    .control-btn {
      padding: 10px 15px;
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 5px;
      transition: 0.2s;
    }

    .control-btn:hover {
      background: var(--light);
    }

    .control-btn.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 15px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 12px;
    }

    .legend-color {
      width: 15px;
      height: 15px;
      border-radius: 3px;
    }

    /* Loading Spinner */
    .spinner {
      display: none;
      width: 40px;
      height: 40px;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .fade-in {
      animation: fadeIn 0.5s ease-out;
    }

    /* Responsive Design */
    @media (max-width: 992px) {
      .container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .schedule-grid {
        font-size: 10px;
      }
      
      .day-header {
        font-size: 11px;
        padding: 8px 3px;
      }
      
      .slot {
        font-size: 9px;
        min-height: 30px;
      }
    }

    @media (max-width: 768px) {
      header h1 {
        font-size: 18px;
      }
      
      header button {
        position: relative;
        left: auto;
        top: auto;
        transform: none;
        margin-top: 10px;
      }
      
      .container {
        padding: 15px;
      }
      
      .schedule-grid {
        grid-template-columns: 80px repeat(7, 1fr);
        font-size: 9px;
      }
    }
  </style>
</head>
<body>
  <header>
    <button onclick="window.location.href='../index.html'">
      <i class="fas fa-home"></i> الرئيسية
    </button>
    <h1>
      <i class="fas fa-graduation-cap"></i>
      <span>Learn English with Nour – Your Lesson Awaits</span>
    </h1>
  </header>

  <div class="container">
    <!-- قسم الحجز والجدول -->
    <div class="booking-section">
      <!-- جدول المواعيد الأسبوعي -->
      <div class="schedule">
        <h2><i class="fas fa-calendar-week"></i> الجدول الأسبوعي للمواعيد</h2>
        
        <div class="schedule-grid" id="scheduleGrid">
          <!-- Headers -->
          <div class="time-slot">الوقت</div>
          <div class="day-header">السبت</div>
          <div class="day-header">الأحد</div>
          <div class="day-header">الإثنين</div>
          <div class="day-header">الثلاثاء</div>
          <div class="day-header">الأربعاء</div>
          <div class="day-header">الخميس</div>
          <div class="day-header">الجمعة</div>
        </div>
        
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color" style="background: #dcfce7;"></div>
            <span>متاح</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #fecaca;"></div>
            <span>محجوز</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: #fef3c7;"></div>
            <span>استراحة</span>
          </div>
          <div class="legend-item">
            <div class="legend-color" style="background: var(--primary);"></div>
            <span>مختار</span>
          </div>
        </div>
      </div>

      <!-- نموذج الحجز -->
      <div class="booking">
        <div id="successMessage" class="success-message">
          <p><i class="fas fa-check-circle"></i> تم حجز الجلسة بنجاح! سيتم إرسال تفاصيل الجلسة إلى رقم الواتساب.</p>
        </div>
        
        <div id="errorMessage" class="error-message">
          <p><i class="fas fa-exclamation-circle"></i> حدث خطأ أثناء الحجز. يرجى المحاولة مرة أخرى.</p>
        </div>

        <h2><i class="fas fa-calendar-alt"></i> احجز جلستك المجانية</h2>
        <form id="bookingForm">
          <label for="name"><i class="fas fa-user"></i> الاسم الكامل</label>
          <input type="text" id="name" placeholder="أدخل اسمك الثلاثي" required>

          <label for="phone"><i class="fas fa-phone"></i> رقم الهاتف</label>
          <input type="tel" id="phone" placeholder="أدخل رقم هاتف واتساب" required>

          <label for="subject"><i class="fas fa-book"></i> الموضوع</label>
          <select id="subject" required>
            <option value="">اختر موضوع الجلسة</option>
            <option value="business">المناهج الدراسية</option>
            <option value="conversation">محادثة عامة</option>
            <option value="grammar">قواعد اللغة</option>
            <option value="exam">تحضير للامتحانات</option>
            <option value="kids">الإنجليزية للأطفال</option>
          </select>

          <input type="hidden" id="selectedSlot" value="">
          <input type="hidden" id="selectedDateTime" value="">

          <button type="button" onclick="bookSession()" id="bookButton">
            <i class="fas fa-calendar-check"></i>
            <span>تأكيد الحجز وبدء الجلسة</span>
          </button>
          
          <div id="loadingSpinner" class="spinner"></div>
        </form>
      </div>
    </div>

    <!-- غرفة الجلسة -->
    <div class="meeting">
      <h2><i class="fas fa-video"></i> غرفة الجلسة التفاعلية</h2>
      <div id="meet">
        <div class="meeting-placeholder">
          <i class="fas fa-video-slash" style="font-size: 60px; margin-bottom: 20px; color: #4cc9f0;"></i>
          <h3 style="margin-bottom: 10px;">الجلسة لم تبدأ بعد</h3>
          <p>بعد تأكيد الحجز، ستظهر غرفة المحادثة المباشرة هنا</p>
          <div style="margin-top: 20px; display: flex; gap: 10px;">
            <div style="display: flex; align-items: center; gap: 5px;">
              <i class="fas fa-microphone" style="color: #4ade80;"></i>
              <span>ميكروفون</span>
            </div>
            <div style="display: flex; align-items: center; gap: 5px;">
              <i class="fas fa-video" style="color: #4ade80;"></i>
              <span>كاميرا</span>
            </div>
          </div>
        </div>
      </div>
      
      <div class="meeting-controls">
        <button class="control-btn" id="micBtn">
          <i class="fas fa-microphone"></i>
          <span>الميكروفون</span>
        </button>
        <button class="control-btn" id="videoBtn">
          <i class="fas fa-video"></i>
          <span>الكاميرا</span>
        </button>
        <button class="control-btn">
          <i class="fas fa-comment"></i>
          <span>الدردشة</span>
        </button>
      </div>
    </div>
  </div>

  <!-- Jitsi API -->
  <script src='https://meet.jit.si/external_api.js'></script>
  
  <script>
    // بيانات الجدول الأسبوعي
    const timeSlots = [
      '09:00', '10:00', '11:00', '12:00', '1:00', 
      '2:00', '3:00', '4:00', '5:00', '6:00', 
      '7:00', '8:00'
    ];
    
    const dayNames = ['saturday','sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
    
    // حالة المواعيد (متاح، محجوز، استراحة)
    let scheduleData = {
     'saturday': { '8:00': 'booked' },
      'sunday': { '2:00': 'break', '3:00': 'break' },
      'monday': { '12:00': 'booked', '1:00': 'booked' },
      'tuesday': { '4:00': 'booked' },
      'wednesday': { '2:00': 'break', '3:00': 'break' },
      'thursday': { '10:00': 'booked', '6:00': 'booked' },
      'friday': { '12:00': 'break', '1:00': 'break', '2:00': 'break', '3:00': 'break', '4:00': 'break','5:00' :'break',  '6:00':'break', '7:00': 'break', '8:00': 'break' },
    };
    
    let selectedSlot = null;

    // إنشاء الجدول الأسبوعي
    function createScheduleGrid() {
      const grid = document.getElementById('scheduleGrid');
      
      timeSlots.forEach(time => {
        // إضافة خانة الوقت
        const timeDiv = document.createElement('div');
        timeDiv.className = 'time-slot';
        timeDiv.textContent = time;
        grid.appendChild(timeDiv);
        
        // إضافة خانات أيام الأسبوع لهذا الوقت
        dayNames.forEach(day => {
          const slotDiv = document.createElement('div');
          slotDiv.className = 'slot';
          slotDiv.dataset.day = day;
          slotDiv.dataset.time = time;
          
          // تحديد حالة الموعد
          const status = scheduleData[day] && scheduleData[day][time];
          
          if (status === 'booked') {
            slotDiv.classList.add('booked');
            slotDiv.innerHTML = '<i class="fas fa-times"></i>';
          } else if (status === 'break') {
            slotDiv.classList.add('teacher-break');
            slotDiv.innerHTML = '<i class="fas fa-coffee"></i>';
          } else {
            slotDiv.classList.add('available');
            slotDiv.innerHTML = '<i class="fas fa-check"></i>';
            slotDiv.addEventListener('click', () => selectTimeSlot(slotDiv, day, time));
          }
          
          grid.appendChild(slotDiv);
        });
      });
    }

    // اختيار موعد من الجدول
    function selectTimeSlot(slotElement, day, time) {
      // إلغاء التحديد السابق
      document.querySelectorAll('.slot.selected').forEach(slot => {
        slot.classList.remove('selected');
      });
      
      // تحديد الموعد الجديد
      slotElement.classList.add('selected');
      selectedSlot = { day, time, element: slotElement };
      
      // تحديث الحقول المخفية
      document.getElementById('selectedSlot').value = `${day}-${time}`;
      
      // تحويل اليوم والتاريخ إلى تاريخ فعلي
      const today = new Date();
      const currentDay = today.getDay(); // 0 = Sunday, 1 = Monday, etc.
      const dayIndex = dayNames.indexOf(day);
      
      let targetDate = new Date(today);
      let daysToAdd = dayIndex - currentDay;
      if (daysToAdd < 0) daysToAdd += 7; // إذا كان اليوم في الأسبوع القادم
      
      targetDate.setDate(today.getDate() + daysToAdd);
      const formattedDate = `${targetDate.getFullYear()}-${String(targetDate.getMonth() + 1).padStart(2, '0')}-${String(targetDate.getDate()).padStart(2, '0')} ${time}:00`;
      
      document.getElementById('selectedDateTime').value = formattedDate;
      
      // إظهار رسالة التأكيد
      const dayArabic = getDayArabicName(day);
      alert(`تم اختيار موعد: ${dayArabic} ${time}`);
    }

    // تحويل اسم اليوم إلى العربية
    function getDayArabicName(day) {
      const arabicDays = {
        'sunday': 'الأحد',
        'monday': 'الإثنين', 
        'tuesday': 'الثلاثاء',
        'wednesday': 'الأربعاء',
        'thursday': 'الخميس',
        'friday': 'الجمعة',
        'saturday': 'السبت'
      };
      return arabicDays[day];
    }

    // حجز الجلسة
    async function bookSession() {
      const form = document.getElementById('bookingForm');
      if (!form.checkValidity()) {
        alert('يرجى ملء جميع الحقول المطلوبة بشكل صحيح');
        return;
      }
      
      if (!selectedSlot) {
        alert('يرجى اختيار موعد من الجدول الأسبوعي');
        return;
      }
      
      // إظهار رسالة التحميل
      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('bookButton').disabled = true;
      document.getElementById('errorMessage').style.display = 'none';
      
      // جمع بيانات النموذج
      const formData = {
        name: document.getElementById('name').value,
        phone: document.getElementById('phone').value,
        subject: document.getElementById('subject').value,
        slot: document.getElementById('selectedSlot').value,
        datetime: document.getElementById('selectedDateTime').value,
        timestamp: new Date().toISOString()
      };
      
      try {
        // إرسال البيانات إلى Google Sheets
        const response = await fetch('https://script.google.com/macros/s/AKfycbyiepT9socMcvByZ-AlOsh5GBd2DYbUXzFcqEW7-z-ej95X9PRBiu7NaF7MvVufwPdWwQ/exec', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(formData)
        });
        
        if (response.ok) {
          // نجح الحجز
          document.getElementById('successMessage').style.display = 'block';
          document.getElementById('successMessage').classList.add('fade-in');
          
          // تحديث حالة الموعد في الجدول
          selectedSlot.element.classList.remove('available', 'selected');
          selectedSlot.element.classList.add('booked');
          selectedSlot.element.innerHTML = '<i class="fas fa-times"></i>';
          selectedSlot.element.removeEventListener('click', selectTimeSlot);
          
          // تحديث البيانات المحلية
          if (!scheduleData[selectedSlot.day]) {
            scheduleData[selectedSlot.day] = {};
          }
          scheduleData[selectedSlot.day][selectedSlot.time] = 'booked';
          
          // بدء الجلسة
          startMeeting(formData.name);
          
          // إعادة تعيين النموذج
          form.reset();
          selectedSlot = null;
          document.getElementById('selectedSlot').value = '';
          document.getElementById('selectedDateTime').value = '';
          
        } else {
          throw new Error('فشل في الحجز');
        }
        
      } catch (error) {
        console.error('خطأ في الحجز:', error);
        document.getElementById('errorMessage').style.display = 'block';
        document.getElementById('errorMessage').classList.add('fade-in');
      } finally {
        // إخفاء التحميل وإعادة تمكين الزر
        document.getElementById('loadingSpinner').style.display = 'none';
        document.getElementById('bookButton').disabled = false;
      }
    }

    // بدء جلسة الفيديو
    function startMeeting(userName) {
      const domain = "meet.jit.si";
      const roomName = "EnglishLesson_" + userName.replace(/\s+/g, '') + "_" + Math.floor(Math.random() * 10000);
      
      const options = {
        roomName: roomName,
        width: "100%",
        height: "100%",
        parentNode: document.querySelector('#meet'),
        userInfo: {
          displayName: userName
        },
        interfaceConfigOverwrite: { 
          DEFAULT_REMOTE_DISPLAY_NAME: 'ضيف',
          SHOW_JITSI_WATERMARK: false,
          SHOW_WATERMARK_FOR_GUESTS: false
        },
        configOverwrite: {
          prejoinPageEnabled: false
        }
      };
      
      const api = new JitsiMeetExternalAPI(domain, options);
      
      // إضافة مستمعي الأحداث
      api.addEventListener('participantJoined', (participant) => {
        console.log('انضم مشارك:', participant);
      });
      
      api.addEventListener('videoConferenceLeft', () => {
        document.getElementById('meet').innerHTML = `
          <div class="meeting-placeholder">
            <i class="fas fa-video-slash" style="font-size: 60px; margin-bottom: 20px; color: #4cc9f0;"></i>
            <h3 style="margin-bottom: 10px;">انتهت الجلسة</h3>
            <p>شكراً لك على حضور الجلسة!</p>
          </div>
        `;
      });
    }

    // التحكم في أزرار الميكروفون والكاميرا
    document.getElementById('micBtn').addEventListener('click', function() {
      this.classList.toggle('active');
      const icon = this.querySelector('i');
      if (this.classList.contains('active')) {
        icon.className = 'fas fa-microphone-slash';
      } else {
        icon.className = 'fas fa-microphone';
      }
    });
    
    document.getElementById('videoBtn').addEventListener('click', function() {
      this.classList.toggle('active');
      const icon = this.querySelector('i');
      if (this.classList.contains('active')) {
        icon.className = 'fas fa-video-slash';
      } else {
        icon.className = 'fas fa-video';
      }
    });

    // تأثيرات تفاعلية للحقول
    document.querySelectorAll('input, select').forEach(element => {
      element.addEventListener('focus', function() {
        this.parentElement.style.transform = 'translateY(-2px)';
      });
      
      element.addEventListener('blur', function() {
        this.parentElement.style.transform = 'translateY(0)';
      });
    });

    // تحديث الجدول كل 30 ثانية (اختياري)
    setInterval(updateScheduleFromServer, 30000);

    async function updateScheduleFromServer() {
      try {
        // يمكنك إضافة استدعاء API هنا لتحديث الجدول من الخادم
        console.log('تحديث الجدول...');
      } catch (error) {
        console.error('خطأ في تحديث الجدول:', error);
      }
    }

    // إنشاء الجدول عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      createScheduleGrid();
    });
  </script>
</body>
</html>