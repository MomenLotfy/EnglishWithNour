<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>EnglishWithNour - Vocabulary</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
  <script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
  <link rel="stylesheet" href="../css/style.css" />
  
  <style>
    /* إضافة الكلاس no-animation لإزالة الحركة عند بدء التشغيل */
    .topic-panel.no-animation {
      transition: none !important;
    }
    
    .topic-panel.no-animation .topic-panel-content {
      transition: none !important;
    }
  </style>
</head>
<body>
   <!-- Bottom Navigation (mobile/tablet) -->
   <nav class="bottom-nav">
  <a href="../index.html" class="bottom-nav-link active" aria-label="Home">
    <ion-icon name="home-outline"></ion-icon>
    <span>Home</span>
    <span class="ripple"></span>
  </a>

  <a href="Grammar.html" class="bottom-nav-link" aria-label="Grammar">
    <ion-icon name="book-outline"></ion-icon>
    <span>Grammar</span>
    <span class="ripple"></span>
  </a>

  <a href="Vocabulary.html" class="bottom-nav-link" aria-label="Vocabulary">
    <ion-icon name="list-outline"></ion-icon>
    <span>Vocab</span>
    <span class="ripple"></span>
  </a>

  <a href="../ComingSoon.html" class="bottom-nav-link" aria-label="Exams">
    <ion-icon name="document-text-outline"></ion-icon>
    <span>Exams</span>
    <span class="ripple"></span>
  </a>
   <a href="#" class="bottom-nav-link sidebar-toggle" aria-label="Menu">
  <ion-icon name="menu-outline"></ion-icon>
  <span>Menu</span>
  </a>
</nav><!-- Overlay -->
<div id="overlay" class="overlay"></div>

<!-- Sidebar -->
<aside id="sidebar" class="sidebar">
  <!-- Header -->
  <div class="sidebar-header">
    <h2 class="logo">EnglishWithNour</h2>
    <button class="close-btn" id="close-sidebar">
      <ion-icon name="close-outline"></ion-icon>
    </button>
  </div>

  <!-- Navigation Links -->
  <nav class="sidebar-nav">
    <a href="../index.html"><ion-icon name="home-outline"></ion-icon> Home</a>
    <a href="Grammar.html"><ion-icon name="book-outline"></ion-icon> Grammar</a>
    <a href="Vocabulary.html"><ion-icon name="list-outline"></ion-icon> Vocabulary</a>
    <a href="../ComingSoon.html"><ion-icon name="headset-outline"></ion-icon> Listening</a>
    <a href="../ComingSoon.html"><ion-icon name="create-outline"></ion-icon> Writing</a>
    <a href="../ComingSoon.html"><ion-icon name="library-outline"></ion-icon> Reading</a>
    <a href="../ComingSoon.html"><ion-icon name="document-text-outline"></ion-icon> Exams</a>
  </nav>

  <!-- Footer -->
  <div class="sidebar-footer">
    <p class="tagline">
      Learn English step-by-step with fun and interactive lessons designed for Arabic speakers of all ages.
    </p>
    <div class="social-icons">
      <a href="#"><ion-icon name="logo-facebook"></ion-icon></a>
      <a href="#"><ion-icon name="logo-youtube"></ion-icon></a>
      <a href="#"><ion-icon name="logo-instagram"></ion-icon></a>
    </div>
  </div>
</aside>
  <div class="container-fluid px-0">
    <!-- Navbar (same structure as Grammar) -->
    <header class="navbar">
      <div class="container">
        <a href="../index.html" class="logo-bg" aria-label="EnglishWithNour logo"></a>
        <nav id="nav-links" aria-label="Main navigation">
          <a href="../index.html">Home</a>
          <a href="Grammar.html">Grammar</a>
          <a href="Vocabulary.html" class="active" aria-current="page">Vocabulary</a>
          <a href="../ComingSoon.html">Listening</a>
          <a href="../ComingSoon.html">Writing</a>
          <a href="../ComingSoon.html">Reading</a>
          <a href="../ComingSoon.html">Exams</a>
        </nav>
        <div class="account-btn" role="button" tabindex="0">Sign in</div>
      </div>
    </header>

    <!-- Vocabulary Container -->
    <div class="vocab-container">
      <header class="vocab-header">
        <!-- Level Tabs -->
        <div class="vocab-tabs" id="levelTabs" role="tablist" aria-label="Vocabulary Levels">
          <button class="vocab-tab" data-level="A1" role="tab" aria-selected="false" id="tab-A1">A1 Elementary</button>
          <button class="vocab-tab" data-level="A2" role="tab" aria-selected="false" id="tab-A2">A2 Pre-intermediate</button>
          <button class="vocab-tab" data-level="B1" role="tab" aria-selected="false" id="tab-B1">B1 Intermediate</button>
          <button class="vocab-tab" data-level="B2" role="tab" aria-selected="false" id="tab-B2">B2 Upper-intermediate</button>
          <button class="vocab-tab" data-level="C1" role="tab" aria-selected="false" id="tab-C1">C1 Advanced</button>
        </div>

        <!-- Search box (search words, not topics) -->
        <div class="vocab-search-box">
          <input id="searchInput" type="text" placeholder="Search for words..." aria-label="Search vocabulary words" />
        </div>
      </header>

      <main class="container-main">
        <!-- Level header + progress -->
        <div class="vocab-level-header">
          <h2 id="levelTitle">A1 — Elementary</h2>
          <div class="vocab-progress" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" aria-labelledby="levelTitle">
            <i id="progressBar"></i>
          </div>
          <div id="progressPct" aria-label="Progress percentage">0%</div>
        </div>

        <!-- Accordion area -->
        <div id="vocabAccordion" class="accordion"></div>

        <!-- Empty / loading spot -->
        <div id="vocabEmptySpot" class="vocab-empty-spot" style="display:none; margin-top:18px;">
          <i class="fas fa-search" style="font-size: 2rem; color: #00cc55; margin-bottom: 10px;"></i>
          <p id="emptyMessage">No words found — try a different search term or level.</p>
        </div>
      </main>
    </div>

    <!-- Footer (same as Grammar) -->
    <footer class="footer">
      <div class="footer-container">

        <!-- Brand -->
        <div class="footer-brand">
          <h2>EnglishWithNour</h2>
          <p>Learn English step-by-step with fun and interactive lessons designed for Arabic speakers of all ages.</p>
        </div>

        <!-- Skills -->
        <div class="footer-skills">
          <h3>Explore</h3>
          <div class="skills-columns">
            <ul>
              <li><a href="Grammar.html">Grammar</a></li>
              <li><a href="Vocabulary.html">Vocabulary</a></li>
            </ul>
            <ul>
              <li><a href="../ComingSoon.html">Reading</a></li>
              <li><a href="../ComingSoon.html">Writing</a></li>
            </ul>
            <ul>
              <li><a href="../ComingSoon.html">Listening</a></li>
              <li><a href="../ComingSoon.html">Exams</a></li>
            </ul>
          </div>
        </div>

        <!-- Social -->
        <div class="footer-social">
          <h3>Follow Us</h3>
          <div class="social-icons">
            <a href="#"><i class="fab fa-facebook-f"></i></a>
            <a href="#"><i class="fab fa-youtube"></i></a>
            <a href="#"><i class="fab fa-instagram"></i></a>
          </div>
        </div>

      </div>

      <div class="footer-bottom">
        <p>© 2025 English With Nour. All rights reserved.</p>
      </div>
    </footer>
  </div>

  <!-- Bootstrap JS bundle -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <!-- vocabulary data -->
  <script src="../js/VocabularyData.js"></script>
   <script>
  const sidebar = document.getElementById("sidebar");
  const overlay = document.getElementById("overlay");
  const openBtn = document.querySelector(".sidebar-toggle");
  const closeBtn = document.getElementById("close-sidebar");

  // فتح السايد بار
  openBtn.addEventListener("click", (e) => {
    e.preventDefault();
    sidebar.classList.add("active");
    overlay.classList.add("active");
  });

  // إغلاق بالزر
  closeBtn.addEventListener("click", () => {
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
  });

  // إغلاق بالضغط على الخلفية
  overlay.addEventListener("click", () => {
    sidebar.classList.remove("active");
    overlay.classList.remove("active");
  });
</script>


  <script>
    
    // ---------- Sidebar History Management ----------
    let sidebarHistoryState = null;
    let isRefreshRestore = false; // فلاج لتتبع الاستعادة من الريفرش

    function openSidebar(withAnimation = true, isRestore = false) {
      const panel = document.getElementById('topicPanel');
      
      // إزالة no-animation إذا كانت موجودة للسماح بالحركة
      if (withAnimation) {
        panel.classList.remove('no-animation');
      } else {
        panel.classList.add('no-animation');
      }
      
      panel.classList.add('open');
      
      // Add state to history only if not a restore and not already added
      if (!isRestore && !sidebarHistoryState) {
        sidebarHistoryState = { sidebarOpen: true };
        history.pushState(sidebarHistoryState, '');
        
        // حفظ حالة السايدبار فقط عند الفتح الطبيعي (ليس الاستعادة)
        localStorage.setItem('sidebarOpen', 'true');
      }
      
      // إزالة no-animation بعد فترة قصيرة لتجنب المشاكل
      if (!withAnimation) {
        setTimeout(() => {
          panel.classList.remove('no-animation');
        }, 100);
      }
    }

    function closeSidebar(clearStorage = true) {
      const panel = document.getElementById('topicPanel');
      panel.classList.remove('open');
      
      // Remove the state from history if it exists
      if (sidebarHistoryState) {
        // Use replaceState to avoid adding more history entries
        history.replaceState(null, '');
        sidebarHistoryState = null;
      }
      
      // إزالة حالة السايدبار من localStorage فقط إذا كان مطلوباً
      if (clearStorage) {
        localStorage.removeItem('sidebarOpen');
        localStorage.removeItem('sidebarContent');
        localStorage.removeItem('sidebarTitle');
        localStorage.removeItem('sidebarTopic');
      }
    }

    // حفظ محتوى السايدبار
    function saveSidebarContent(title, topic, content) {
      localStorage.setItem('sidebarTitle', title);
      localStorage.setItem('sidebarTopic', topic);
      localStorage.setItem('sidebarContent', content);
    }

    // استرجاع محتوى السايدبار
    function restoreSidebarContent() {
      const title = localStorage.getItem('sidebarTitle');
      const topic = localStorage.getItem('sidebarTopic');
      const content = localStorage.getItem('sidebarContent');
      
      if (title && topic && content) {
        document.getElementById('topicPanelBody').innerHTML = content;
        return true;
      }
      return false;
    }

    // دالة للتحقق من كون الصفحة تم تحميلها من الريفرش أم من التنقل
    function isPageRefreshed() {
      return performance.navigation.type === performance.navigation.TYPE_RELOAD;
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', function(event) {
      const panel = document.getElementById('topicPanel');
      
      if (panel.classList.contains('open')) {
        // Close sidebar when back button is pressed without clearing storage
        closeSidebar(false);
        
        // منع المزيد من التنقل للخلف
        event.preventDefault();
        return;
      }
    });

    // التعامل مع حالة مغادرة الصفحة
    window.addEventListener('beforeunload', function() {
      const panel = document.getElementById('topicPanel');
      // إذا كان السايدبار مفتوحاً، احفظ الحالة للريفرش
      if (!panel.classList.contains('open')) {
        // إذا كان السايدبار مغلق، امسح البيانات المحفوظة
        localStorage.removeItem('sidebarOpen');
        localStorage.removeItem('sidebarContent');
        localStorage.removeItem('sidebarTitle');
        localStorage.removeItem('sidebarTopic');
      }
    });

    

    
// ---------- Helpers ----------
function toSlug(text) {
  return String(text || "").toLowerCase()
    .replace(/[^a-z0-9]+/g, '-')
    .replace(/(^-|-$)/g, '');
}

const keyFor = (level, topicKey, wordSlug) => `vocabCompleted::${level}::${topicKey}::${wordSlug}`;

// ---------- Web Speech API Functions ----------
function speakText(text, accent = 'en-GB') {
  if (!('speechSynthesis' in window)) {
    alert('Your browser does not support speech synthesis. Try using Chrome or Edge.');
    return;
  }
  
  window.speechSynthesis.cancel();
  const utterance = new SpeechSynthesisUtterance(text);
  utterance.lang = accent;
  utterance.rate = 0.8;
  utterance.pitch = 1;
  utterance.volume = 1;
  
  window.speechSynthesis.speak(utterance);
}


// ---------- Accent System ----------
let selectedAccent = localStorage.getItem('selectedAccent') || 'en-GB';

// دالة تبديل اللهجة
function toggleAccent() {
  selectedAccent = selectedAccent === 'en-GB' ? 'en-US' : 'en-GB';
  localStorage.setItem('selectedAccent', selectedAccent);
  updateAccentButton();
  updateWordIndicators();
}

// تحديث زر اللهجة
function updateAccentButton() {
  const accentBtn = document.getElementById('accentToggle');
  if (accentBtn) {
    if (selectedAccent === 'en-GB') {
      accentBtn.innerHTML = `
        <img src="https://flagcdn.com/16x12/gb.png" alt="UK" style="width:18px; vertical-align:middle; margin-right:6px;">
        UK Accent
      `;
      accentBtn.className = 'accent-btn uk-accent';
    } else {
      accentBtn.innerHTML = `
        <img src="https://flagcdn.com/16x12/us.png" alt="US" style="width:18px; vertical-align:middle; margin-right:6px;">
        US Accent
      `;
      accentBtn.className = 'accent-btn us-accent';
    }
  }
}

// تحديث المؤشرات البصرية للكلمات
function updateWordIndicators() {
  document.querySelectorAll('.speakable-word').forEach(word => {
    word.classList.remove('uk-mode', 'us-mode');
    word.classList.add(selectedAccent === 'en-GB' ? 'uk-mode' : 'us-mode');
  });
}

// دالة إظهار تأكيد النطق
function showPronunciationFeedback(element) {
  const feedback = document.createElement('div');
  feedback.className = 'pronunciation-feedback';
  feedback.innerHTML = `
    <i class="fas fa-volume-up"></i>
    ${selectedAccent === 'en-GB' ? 'UK' : 'US'}
  `;
  
  element.appendChild(feedback);
  
  setTimeout(() => {
    feedback.remove();
  }, 1000);
}

// ---------- State ----------
let currentLevel = localStorage.getItem('selectedLevelVocab') || 'A1';
let searchTerm = '';

// ---------- DOM refs ----------
const accordionContainer = () => document.getElementById('vocabAccordion');
const emptySpot = () => document.getElementById('vocabEmptySpot');
const emptyMsg = () => document.getElementById('emptyMessage');

// ---------- Render functions ----------
function renderTabs() {
  document.querySelectorAll('.vocab-tab').forEach(tab => {
    const lvl = tab.dataset.level;
    tab.classList.toggle('active', lvl === currentLevel);
    tab.setAttribute('aria-selected', lvl === currentLevel ? 'true' : 'false');
    tab.addEventListener('click', () => {
      document.querySelectorAll('.vocab-tab').forEach(t => {
        t.classList.remove('active');
        t.setAttribute('aria-selected', 'false');
      });
      tab.classList.add('active');
      tab.setAttribute('aria-selected', 'true');

      currentLevel = lvl;
      localStorage.setItem('selectedLevelVocab', currentLevel);
      updateLevelTitle();
      renderAccordion(searchTerm);
    });

    tab.addEventListener('keydown', e => {
      if (e.key === 'Enter' || e.key === ' ') {
        e.preventDefault();
        tab.click();
      }
    });
  });
}

function updateLevelTitle() {
  const titleEl = document.getElementById('levelTitle');
  const labelMap = {
    A1: 'A1 — A1 Elementary',
    A2: 'A2 — A2 Pre-intermediate',
    B1: 'B1 — B1 Intermediate',
    B2: 'B2 — B2 Upper-intermediate',
    C1: 'C1 — C1 Advanced'
  };
  if (titleEl) titleEl.textContent = labelMap[currentLevel] || currentLevel;
}

// ---------- Render functions ----------
function renderAccordion(filter = '') {
  if (typeof vocabData === 'undefined') {
    // بيانات وهمية للاختبار
    window.vocabData = {
      A1: {
        greetings: {
          title: "Greetings & Introductions",
          subtitle: "Basic greetings and how to introduce yourself",
          wordCount: 15,
          type: "table",
          items: [
            { word: "Hello", arabic: "مرحبا", uk: "/həˈləʊ/", us: "/həˈloʊ/", example: "Hello, how are you?" },
            { word: "Good morning", arabic: "صباح الخير", uk: "/ɡʊd ˈmɔːnɪŋ/", us: "/ɡʊd ˈmɔːrnɪŋ/", example: "Good morning, everyone!" },
            { word: "Thank you", arabic: "شكرا لك", uk: "/θæŋk juː/", us: "/θæŋk juː/", example: "Thank you for your help." }
          ]
        },
        family: {
          title: "Family Members",
          subtitle: "Learn about family relationships",
          wordCount: 12,
          type: "paragraph",
          content: `
            <p>Family is very important in every culture. Here are some basic family words:</p>
            <p>My <span class="speakable-word" data-word="mother" title="أم - الوالدة">mother</span> is very kind. 
            My <span class="speakable-word" data-word="father" title="أب - الوالد">father</span> works hard. 
            I have a <span class="speakable-word" data-word="brother" title="أخ - الأخ">brother</span> and a 
            <span class="speakable-word" data-word="sister" title="أخت - الأخت">sister</span>.</p>
            <p>My <span class="speakable-word" data-word="grandmother" title="جدة - الجدة">grandmother</span> tells 
            great stories, and my <span class="speakable-word" data-word="grandfather" title="جد - الجد">grandfather</span> 
            is very wise.</p>
          `
        }
      }
    };
    
    accordionContainer().innerHTML = '<p class="text-muted">Loading vocabulary data...</p>';
  }

  const levelData = vocabData[currentLevel];
  const container = accordionContainer();
  container.innerHTML = '';

  if (!levelData || Object.keys(levelData).length === 0) {
    emptySpot().style.display = 'block';
    emptyMsg().textContent = 'This level is under development. Check back later.';
    updateProgress();
    return;
  }

  emptySpot().style.display = 'none';

  const searchLower = (filter || '').trim().toLowerCase();
  let matchedAny = false;

  Object.keys(levelData).forEach((topicKey, idx) => {
    const topic = levelData[topicKey];
    
    let shouldShow = false;
    
    if (topic.type === "table" && topic.items) {
      const itemsFiltered = topic.items.filter(it => {
        if (!searchLower) return true;
        // البحث الدقيق في عمود word فقط (مطابقة كاملة أو جزئية)
        return (it.word && it.word.toLowerCase().includes(searchLower));
      });
      shouldShow = itemsFiltered.length > 0;
      topic.filteredItems = itemsFiltered;
    } else if (topic.type === "paragraph") {
      if (!searchLower) {
        shouldShow = true;
      } else {
        // البحث في الكلمات القابلة للنطق فقط داخل الفقرات
        const tempDiv = document.createElement('div');
        tempDiv.innerHTML = topic.content;
        const speakableWords = tempDiv.querySelectorAll('.speakable-word');
        const words = Array.from(speakableWords).map(word => word.dataset.word.toLowerCase());
        shouldShow = words.some(word => word.includes(searchLower));
      }
    }

    if (!shouldShow) return;

    matchedAny = true;

    const topicId = `collapse-${currentLevel}-${toSlug(topicKey)}-${idx}`;
    const headingId = `heading-${currentLevel}-${toSlug(topicKey)}-${idx}`;

    let accordionContent = '';
    if (topic.type === "table" && topic.filteredItems) {
      const rowsHtml = topic.filteredItems.map(it => {
        const ukPronunciation = `
          ${it.uk || ''}
          ${it.audioUk 
            ? `<button class="play-btn btn btn-sm btn-outline-primary ms-1" data-src="${it.audioUk}" title="Play UK Audio">🗣 UK</button>` 
            : `<button class="speak-btn btn btn-sm btn-outline-secondary ms-1" data-text="${it.word}" data-accent="en-GB" title="Speak UK">🗣 UK</button>`
          }
        `;

        const usPronunciation = `
          ${it.us || ''}
          ${it.audioUs 
            ? `<button class="play-btn btn btn-sm btn-outline-primary ms-1" data-src="${it.audioUs}" title="Play US Audio">🗣 US</button>` 
            : `<button class="speak-btn btn btn-sm btn-outline-secondary ms-1" data-text="${it.word}" data-accent="en-US" title="Speak US">🗣 US</button>`
          }
        `;

        const exampleWithSpeak = it.example ? `${it.example}` : '';

        return `
          <tr>
            <td class="align-middle"><strong>${it.word}</strong></td>
            <td class="align-middle">${it.arabic || ''}</td>
            <td class="align-middle">${ukPronunciation}</td>
            <td class="align-middle">${usPronunciation}</td>
            <td class="align-middle">${exampleWithSpeak}</td>
          </tr>
        `;
      }).join('');

      accordionContent = `
        <table class="table-modern">
          <thead>
            <tr>
              <th>Word</th>
              <th>Arabic</th>
              <th>
                <img src="https://flagcdn.com/16x12/gb.png" alt="UK" style="width:18px; vertical-align:middle; margin-right:6px;">
                UK Pronunciation
              </th>
              <th>
                <img src="https://flagcdn.com/16x12/us.png" alt="US" style="width:18px; vertical-align:middle; margin-right:6px;">
                US Pronunciation
              </th>
              <th>Example</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    } else if (topic.type === "paragraph") {
      accordionContent = `<p class="text-muted">Click the title to view this content in the sidebar.</p>`;
    }

    const accordionItem = document.createElement('div');
    accordionItem.className = 'accordion-item mb-2';

    const topicSlug = toSlug(topicKey);
    const chkId = `chk-${currentLevel}-${topicSlug}`;
    const checked = !!localStorage.getItem(keyFor(currentLevel, topicSlug)) ? 'checked' : '';

accordionItem.innerHTML = `
  <h2 class="accordion-header" id="${headingId}">
    <div class="accordion-header-content d-flex justify-content-between align-items-center w-100">
      
      <!-- Left side: Checkbox + Titles -->
      <div class="accordion-titles d-flex flex-column align-items-start">
        <div class="d-flex align-items-center gap-2">
          <input class="topic-chk" id="${chkId}" type="checkbox" 
            data-level="${currentLevel}" data-topic="${topicSlug}" ${checked} />
          <span class="accordion-title">${topic.title}</span>
        </div>
        ${topic.subtitle ? `<span class="accordion-subtitle">${topic.subtitle}</span>` : ""}
      </div>

      <!-- Right side: Word count + Start button -->
      <div class="accordion-actions text-end">
        ${topic.wordCount ? `<div class="accordion-wordcount">عدد الكلمات: ${topic.wordCount}</div>` : ""}
        <button class="start-btn open-panel-btn" 
          type="button"
          data-topic="${topicSlug}" 
          data-title="${topic.title}">
          Start
        </button>
      </div>
    </div>
  </h2>

  <!-- Hidden accordion collapse -->
  <div id="${topicId}" class="accordion-collapse collapse d-none">
    <div class="accordion-body p-0">
      ${accordionContent}
    </div>
  </div>
`;

    container.appendChild(accordionItem);
  });

  if (!matchedAny) {
    emptySpot().style.display = 'block';
    emptyMsg().textContent = `No words found for "${filter}" in ${currentLevel}.`;
  } else {
    emptySpot().style.display = 'none';
  }

  // Add event listeners to speak buttons
  document.querySelectorAll('.speak-btn').forEach(btn => {
    btn.addEventListener('click', (e) => {
      e.stopPropagation();
      const text = btn.getAttribute('data-text');
      const accent = btn.getAttribute('data-accent');
      speakText(text, accent);
    });
  });

  // Open sidebar with content
container.querySelectorAll('.open-panel-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const title = btn.dataset.title;
    const topicKey = btn.dataset.topic;
    const topic = levelData[Object.keys(levelData).find(k => toSlug(k) === topicKey)];
    let html = `<h3>${title}</h3>`;

  if (topic.type === "table") {
  const itemsToShow = topic.filteredItems || topic.items;
  const rowsHtml = itemsToShow.map(it => {
    const exampleWithSpeak = it.example ? `${it.example}` : '';
    return `
      <tr>
        <td data-label="Word"><strong>${it.word}</strong></td>
        <td data-label="Arabic">${it.arabic || ''}</td>
        <td data-label="UK Pronunciation">
          ${it.uk || ''}
          ${it.audioUk 
            ? `<button class="play-btn btn btn-sm btn-outline-primary ms-1" data-src="${it.audioUk}" title="Play UK Audio">🔊 UK</button>` 
            : `<button class="speak-btn btn btn-sm btn-outline-secondary ms-1" data-text="${it.word}" data-accent="en-GB" title="Speak UK">🗣 UK</button>`}
        </td>
        <td data-label="US Pronunciation">
          ${it.us || ''}
          ${it.audioUs 
            ? `<button class="play-btn btn btn-sm btn-outline-primary ms-1" data-src="${it.audioUs}" title="Play US Audio">🔊 US</button>` 
            : `<button class="speak-btn btn btn-sm btn-outline-secondary ms-1" data-text="${it.word}" data-accent="en-US" title="Speak US">🗣 US</button>`}
        </td>
        <td data-label="Example">${exampleWithSpeak}</td>
      </tr>
    `;
  }).join('');

  html += `
    <table class="table-modern">
      <thead>
        <tr>
          <th>Word</th>
          <th>Arabic</th>
          <th>
            <img src="https://flagcdn.com/16x12/gb.png" alt="UK" style="width:18px; vertical-align:middle; margin-right:6px;">
            UK Pronunciation
          </th>
          <th>
            <img src="https://flagcdn.com/16x12/us.png" alt="US" style="width:18px; vertical-align:middle; margin-right:6px;">
            US Pronunciation
          </th>
          <th>Example</th>
        </tr>
      </thead>
      <tbody>${rowsHtml}</tbody>
    </table>
  `;
}


    else if (topic.type === "paragraph") {
      html += `
          <!-- شريط التحكم في اللهجة -->
          <div class="accent-control-bar">
            <div class="accent-info">
              <i class="fas fa-volume-up me-2"></i>
              <span>Pronunciation Mode:</span>
            </div>
            <button id="accentToggle" class="accent-btn uk-accent" onclick="toggleAccent()" title="Switch between UK and US pronunciation">
              <img src="https://flagcdn.com/16x12/gb.png" alt="UK" style="width:18px; vertical-align:middle; margin-right:6px;">
              UK Accent
            </button>
          </div>
          
          <div class="paragraph-content" id="paragraphContent-${topicKey}">
            ${topic.content}
          </div>
          
          <!-- مؤشر المساعدة -->
          <div class="help-indicator">
            <small><i class="fas fa-info-circle me-1"></i>Click on green words to hear pronunciation. Hover for meaning.</small>
          </div>
      `;
    }

    else {
      html += `<p class="text-muted">No layout defined for this topic.</p>`;
    }

    document.getElementById('topicPanelBody').innerHTML = html;
    
    // حفظ محتوى السايدبار قبل فتحه
    saveSidebarContent(title, topicKey, html);
    
    // Use the new openSidebar function with animation (not a restore)
    openSidebar(true, false);
    
    // Add event listeners to speak buttons in the panel
    document.querySelectorAll('#topicPanelBody .speak-btn').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const text = btn.getAttribute('data-text');
        const accent = btn.getAttribute('data-accent');
        speakText(text, accent);
      });
    });

    // إضافة مستمعي الأحداث للكلمات القابلة للنطق
    addSpeakableWordListeners();
  });
});

  // Close sidebar using the new closeSidebar function
  document.getElementById('closePanel').addEventListener('click', () => {
    closeSidebar(true); // امسح البيانات المحفوظة عند الإغلاق اليدوي
  });

  // Close if click outside content
  document.getElementById('topicPanel').addEventListener('click', e => {
    if (e.target.id === 'topicPanel') {
      closeSidebar(true); // امسح البيانات المحفوظة عند الإغلاق اليدوي
    }
  });

  // attach checkbox listeners for topics
  container.querySelectorAll('input.topic-chk').forEach(chk => {
    chk.addEventListener('change', () => {
      const L = chk.dataset.level;
      const T = chk.dataset.topic;
      if (chk.checked) {
        localStorage.setItem(keyFor(L, T), '1');
      } else {
        localStorage.removeItem(keyFor(L, T));
      }
      updateProgress();
    });
  });

  updateProgress();
}

// ---------- Search handling ----------
let searchTimeout;
function initSearch() {
  const input = document.getElementById('searchInput');
  if (!input) return;
  input.value = '';
  input.addEventListener('input', (e) => {
    clearTimeout(searchTimeout);
    searchTimeout = setTimeout(() => {
      searchTerm = e.target.value.trim();
      renderAccordion(searchTerm);
    }, 250);
  });
  input.addEventListener('keydown', e => {
    if (e.key === 'Escape') {
      input.value = '';
      searchTerm = '';
      renderAccordion('');
    }
  });
}

// ---------- Progress ----------
function updateProgress() {
  const levelObj = vocabData && vocabData[currentLevel] ? vocabData[currentLevel] : {};
  const topics = Object.keys(levelObj);
  let total = topics.length, completed = 0;

  topics.forEach(topicKey => {
    const key = keyFor(currentLevel, toSlug(topicKey));
    if (localStorage.getItem(key)) completed++;
  });

  const pct = total ? Math.round((completed / total) * 100) : 0;

  const progressBar = document.getElementById('progressBar');
  const progressPct = document.getElementById('progressPct');
  const progressContainer = document.querySelector('.vocab-progress');

  if (progressBar) progressBar.style.width = pct + '%';
  if (progressContainer) progressContainer.setAttribute('aria-valuenow', pct);
  if (progressPct) progressPct.textContent = pct + '%';
}

// ---------- Init page ----------
function initPage() {
  document.querySelectorAll('.vocab-tab').forEach(t => {
    if (t.dataset.level === currentLevel) {
      t.classList.add('active');
      t.setAttribute('aria-selected', 'true');
    } else {
      t.classList.remove('active');
      t.setAttribute('aria-selected', 'false');
    }
  });

  updateLevelTitle();
  renderTabs();
  initSearch();
  renderAccordion('');
  
  // استرجاع حالة السايدبار عند تحميل الصفحة (فقط في حالة الريفرش)
  const sidebarOpen = localStorage.getItem('sidebarOpen');
  if (sidebarOpen === 'true' && isPageRefreshed()) {
    if (restoreSidebarContent()) {
      // فتح السايدبار بدون حركة وكاستعادة من الريفرش
      openSidebar(false, true);
      // إضافة مستمعي الأحداث للكلمات القابلة للنطق
      addSpeakableWordListeners();
      // إضافة مستمعي الأحداث لأزرار النطق
      document.querySelectorAll('#topicPanelBody .speak-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          e.stopPropagation();
          const text = btn.getAttribute('data-text');
          const accent = btn.getAttribute('data-accent');
          speakText(text, accent);
        });
      });
    }
  } else if (sidebarOpen === 'true') {
    // إذا لم تكن الصفحة من الريفرش، امسح البيانات المحفوظة
    localStorage.removeItem('sidebarOpen');
    localStorage.removeItem('sidebarContent');
    localStorage.removeItem('sidebarTitle');
    localStorage.removeItem('sidebarTopic');
  }
}

// DOM ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initPage);
} else {
  initPage();
}

// Expose for debugging if needed
window.vocabDebug = {
  data: () => window.vocabData,
  render: renderAccordion,
  updateProgress
};

// ========== النظام المتقدم للكلمات القابلة للنطق ==========

// دالة إضافة مستمعي الأحداث للكلمات القابلة للنطق
function addSpeakableWordListeners() {
  // تحديث زر اللهجة والمؤشرات
  updateAccentButton();
  updateWordIndicators();
  
  document.querySelectorAll('#topicPanelBody .speakable-word').forEach(word => {
    // إضافة كلاس اللهجة الحالية
    word.classList.add(selectedAccent === 'en-GB' ? 'uk-mode' : 'us-mode');
    
    word.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      // إضافة أنيميشن
      this.classList.add('speaking');
      setTimeout(() => {
        this.classList.remove('speaking');
      }, 600);
      
      // نطق الكلمة باللهجة المختارة
      const wordText = this.dataset.word;
      speakText(wordText, selectedAccent);
      
      // إظهار مؤشر النطق
      showPronunciationFeedback(this);
    });
  });
}

// باقي الكود الموجود
document.querySelectorAll('.play-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    const src = btn.dataset.src;
    if (src) {
      const audio = new Audio(src);
      audio.play();
    }
  });
});

document.querySelectorAll('.play-btn, .speak-btn').forEach(btn => {
  btn.addEventListener('click', function() {
    this.style.animation = 'pulse 0.3s ease-in-out';
    setTimeout(() => {
      this.style.animation = '';
    }, 300);
  });
});

document.querySelectorAll('.table-modern tbody tr').forEach(row => {
  row.addEventListener('click', function() {
    this.style.transform = 'scale(1.01)';
    setTimeout(() => {
      this.style.transform = '';
    }, 150);
  });
});

</script>

    
<!-- Fullscreen Drawer -->
<div id="topicPanel" class="topic-panel">
  <div class="topic-panel-content">
    <button id="closePanel" class="btn btn-danger mb-3">✖ Close</button>
    <div id="topicPanelBody"></div>
  </div>
</div>
</body>
</html>
